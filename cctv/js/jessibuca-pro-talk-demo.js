!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self)["jessibuca-talk"]=e()}(this,(function(){"use strict";class t{on(t,e,i){const s=this.e||(this.e={});return(s[t]||(s[t]=[])).push({fn:e,ctx:i}),this}once(t,e,i){const s=this;function r(){s.off(t,r);for(var o=arguments.length,n=new Array(o),a=0;a<o;a++)n[a]=arguments[a];e.apply(i,n)}return r._=e,this.on(t,r,i)}emit(t){const e=((this.e||(this.e={}))[t]||[]).slice();for(var i=arguments.length,s=new Array(i>1?i-1:0),r=1;r<i;r++)s[r-1]=arguments[r];for(let t=0;t<e.length;t+=1)e[t].fn.apply(e[t].ctx,s);return this}off(t,e){const i=this.e||(this.e={});if(!t)return Object.keys(i).forEach((t=>{delete i[t]})),void delete this.e;const s=i[t],r=[];if(s&&e)for(let t=0,i=s.length;t<i;t+=1)s[t].fn!==e&&s[t].fn._!==e&&r.push(s[t]);return r.length?i[t]=r:delete i[t],this}}const e="debug",i="warn",s="error",r="talkGetUserMediaSuccess",o="talkGetUserMediaFail",n="talkGetUserMediaTimeout",a="talkStreamStart",h="talkStreamOpen",l="talkStreamClose",u="talkStreamError",d="talkStreamInactive",c="talkStreamMsg",p="talkFailedAndStop",f={talkStreamClose:l,talkStreamError:u,talkStreamInactive:d,talkGetUserMediaTimeout:n,talkFailedAndStop:p,talkStreamMsg:c},m={playError:"playIsNotPauseOrUrlIsNull",fetchError:"fetchError",websocketError:"websocketError",webcodecsH265NotSupport:"webcodecsH265NotSupport",webcodecsDecodeError:"webcodecsDecodeError",webcodecsUnsupportedConfigurationError:"webcodecsUnsupportedConfigurationError",webcodecsDecodeConfigureError:"webcodecsDecodeConfigureError",webcodecsAudioInitTimeout:"webcodecsAudioInitTimeout",webcodecsAudioNoDataTimeout:"webcodecsAudioNoDataTimeout",mediaSourceH265NotSupport:"mediaSourceH265NotSupport",mediaSourceAudioG711NotSupport:"mediaSourceAudioG711NotSupport",mediaSourceAudioInitTimeout:"mediaSourceAudioInitTimeout",mediaSourceAudioNoDataTimeout:"mediaSourceAudioNoDataTimeout",mediaSourceDecoderConfigurationError:"mediaSourceDecoderConfigurationError",mediaSourceFull:"mseSourceBufferFull",mseSourceBufferError:"mseSourceBufferError",mseAddSourceBufferError:"mseAddSourceBufferError",mseWorkerAddSourceBufferError:"mseWorkerAddSourceBufferError",mediaSourceAppendBufferError:"mediaSourceAppendBufferError",mediaSourceTsIsMaxDiff:"mediaSourceTsIsMaxDiff",mediaSourceUseCanvasRenderPlayFailed:"mediaSourceUseCanvasRenderPlayFailed",mediaSourceBufferedIsZeroError:"mediaSourceBufferedIsZeroError",wasmDecodeError:"wasmDecodeError",wasmUseVideoRenderError:"wasmUseVideoRenderError",hlsError:"hlsError",webrtcError:"webrtcError",webrtcClosed:"webrtcClosed",webrtcIceCandidateError:"webrtcIceCandidateError",webglAlignmentError:"webglAlignmentError",wasmWidthOrHeightChange:"wasmWidthOrHeightChange",mseWidthOrHeightChange:"mseWidthOrHeightChange",wcsWidthOrHeightChange:"wcsWidthOrHeightChange",widthOrHeightChange:"widthOrHeightChange",tallWebsocketClosedByError:"tallWebsocketClosedByError",flvDemuxBufferSizeTooLarge:"flvDemuxBufferSizeTooLarge",audioChannelError:"audioChannelError",simdH264DecodeVideoWidthIsTooLarge:"simdH264DecodeVideoWidthIsTooLarge",simdDecodeError:"simdDecodeError",webglContextLostError:"webglContextLostError",videoElementPlayingFailed:"videoElementPlayingFailed",videoElementPlayingFailedForWebrtc:"videoElementPlayingFailedForWebrtc",decoderWorkerInitError:"decoderWorkerInitError",decoderWorkerWasmError:"decoderWorkerWasmError",videoInfoError:"videoInfoError",streamEnd:"streamEnd",websocket1006Error:"websocket1006Error",delayTimeout:"delayTimeout",loadingTimeout:"loadingTimeout",networkDelayTimeout:"networkDelayTimeout",aliyunRtcError:"aliyunRtcError",mseWaitVideoCanplayTimeout:"mseWaitVideoCanplayTimeout",initDecoderWorkerTimeout:"initDecoderWorkerTimeout",...{talkStreamError:u,talkStreamClose:l}},g="notConnect",w="open",_="close",b="error",T="g711a",k="g711u",y="pcm",A="opus",S=8,E=0,B=98,v="empty",L="rtp",M="jtt",U="tcp",G="open",C="close",N="error",R="message",W="worklet",F="script",O={encType:T,packetType:L,packetTcpSendType:U,rtpSsrc:"0000000000",numberChannels:1,sampleRate:8e3,sampleBitsWidth:16,frameDuration:20,debug:!1,debugLevel:i,testMicrophone:!1,saveToTempFile:!1,audioBufferLength:160,engine:W,checkGetUserMediaTimeout:!1,getUserMediaTimeout:1e4,audioConstraints:{latency:!0,noiseSuppression:!0,autoGainControl:!0,echoCancellation:!0,sampleRate:48e3,channelCount:1},isG711a:!1,isG711u:!1,jttSimNumber:null,jttChannelNumber:1,openWebsocketHeart:!1,websocketHeartInterval:15,websocketHeartContent:""},x="worklet",D="script",P="active";function I(){}function z(){return(new Date).getTime()}(function(t,e){return t(e={exports:{}},e.exports),e.exports})((function(t){!function(){var e="undefined"!=typeof window&&void 0!==window.document?window.document:{},i=t.exports,s=function(){for(var t,i=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],s=0,r=i.length,o={};s<r;s++)if((t=i[s])&&t[1]in e){for(s=0;s<t.length;s++)o[i[0][s]]=t[s];return o}return!1}(),r={change:s.fullscreenchange,error:s.fullscreenerror},o={request:function(t,i){return new Promise(function(r,o){var n=function(){this.off("change",n),r()}.bind(this);this.on("change",n);var a=(t=t||e.documentElement)[s.requestFullscreen](i);a instanceof Promise&&a.then(n).catch(o)}.bind(this))},exit:function(){return new Promise(function(t,i){if(this.isFullscreen){var r=function(){this.off("change",r),t()}.bind(this);this.on("change",r);var o=e[s.exitFullscreen]();o instanceof Promise&&o.then(r).catch(i)}else t()}.bind(this))},toggle:function(t,e){return this.isFullscreen?this.exit():this.request(t,e)},onchange:function(t){this.on("change",t)},onerror:function(t){this.on("error",t)},on:function(t,i){var s=r[t];s&&e.addEventListener(s,i,!1)},off:function(t,i){var s=r[t];s&&e.removeEventListener(s,i,!1)},raw:s};s?(Object.defineProperties(o,{isFullscreen:{get:function(){return Boolean(e[s.fullscreenElement])}},element:{enumerable:!0,get:function(){return e[s.fullscreenElement]}},isEnabled:{enumerable:!0,get:function(){return Boolean(e[s.fullscreenEnabled])}}}),i?t.exports=o:window.screenfull=o):i?t.exports={isEnabled:!1}:window.screenfull={isEnabled:!1}}()})).isEnabled,(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){}})();function j(){const t=window.navigator.userAgent.toLowerCase();return t&&/iphone|ipad|ipod|ios/.test(t)}const $=()=>(()=>{const t=window.navigator.userAgent;return/MicroMessenger/i.test(t)})()&&function(){const t=window.navigator.userAgent.toLowerCase();return/android/i.test(t)}();function q(t){let e="";if("object"==typeof t)try{e=JSON.stringify(t),e=JSON.parse(e)}catch(i){e=t}else e=t;return e}function J(t){return!0===t||"true"===t}class H{constructor(t){const{fromSampleRate:e,toSampleRate:i,channels:s,inputBufferSize:r}=t;if(!e||!i||!s)throw new Error("Invalid settings specified for the resampler.");this.resampler=null,this.fromSampleRate=e,this.toSampleRate=i,this.channels=s||0,this.inputBufferSize=r,this.initialize()}destroy(){this.resampler=null,this.fromSampleRate=null,this.toSampleRate=null,this.channels=null,this.inputBufferSize=null}initialize(){this.fromSampleRate==this.toSampleRate?(this.resampler=t=>t,this.ratioWeight=1):(this.fromSampleRate<this.toSampleRate?(this.linearInterpolation(),this.lastWeight=1):(this.multiTap(),this.tailExists=!1,this.lastWeight=0),this.initializeBuffers(),this.ratioWeight=this.fromSampleRate/this.toSampleRate)}bufferSlice(t){try{return this.outputBuffer.subarray(0,t)}catch(e){try{return this.outputBuffer.length=t,this.outputBuffer}catch(e){return this.outputBuffer.slice(0,t)}}}initializeBuffers(){this.outputBufferSize=Math.ceil(this.inputBufferSize*this.toSampleRate/this.fromSampleRate/this.channels*1.0000004768371582)+this.channels+this.channels;try{this.outputBuffer=new Float32Array(this.outputBufferSize),this.lastOutput=new Float32Array(this.channels)}catch(t){this.outputBuffer=[],this.lastOutput=[]}}linearInterpolation(){this.resampler=t=>{let e,i,s,r,o,n,a,h,l,u=t.length,d=this.channels;if(u%d!=0)throw new Error("Buffer was of incorrect sample length.");if(u<=0)return[];for(e=this.outputBufferSize,i=this.ratioWeight,s=this.lastWeight,r=0,o=0,n=0,a=0,h=this.outputBuffer;s<1;s+=i)for(o=s%1,r=1-o,this.lastWeight=s%1,l=0;l<this.channels;++l)h[a++]=this.lastOutput[l]*r+t[l]*o;for(s-=1,u-=d,n=Math.floor(s)*d;a<e&&n<u;){for(o=s%1,r=1-o,l=0;l<this.channels;++l)h[a++]=t[n+(l>0?l:0)]*r+t[n+(d+l)]*o;s+=i,n=Math.floor(s)*d}for(l=0;l<d;++l)this.lastOutput[l]=t[n++];return this.bufferSlice(a)}}multiTap(){this.resampler=t=>{let e,i,s,r,o,n,a,h,l,u,d,c=t.length,p=this.channels;if(c%p!=0)throw new Error("Buffer was of incorrect sample length.");if(c<=0)return[];for(e=this.outputBufferSize,i=[],s=this.ratioWeight,r=0,n=0,a=0,h=!this.tailExists,this.tailExists=!1,l=this.outputBuffer,u=0,d=0,o=0;o<p;++o)i[o]=0;do{if(h)for(r=s,o=0;o<p;++o)i[o]=0;else{for(r=this.lastWeight,o=0;o<p;++o)i[o]=this.lastOutput[o];h=!0}for(;r>0&&n<c;){if(a=1+n-d,!(r>=a)){for(o=0;o<p;++o)i[o]+=t[n+(o>0?o:0)]*r;d+=r,r=0;break}for(o=0;o<p;++o)i[o]+=t[n++]*a;d=n,r-=a}if(0!==r){for(this.lastWeight=r,o=0;o<p;++o)this.lastOutput[o]=i[o];this.tailExists=!0;break}for(o=0;o<p;++o)l[u++]=i[o]/s}while(n<c&&u<e);return this.bufferSlice(u)}}resample(t){return this.fromSampleRate==this.toSampleRate?this.ratioWeight=1:(this.fromSampleRate<this.toSampleRate?this.lastWeight=1:(this.tailExists=!1,this.lastWeight=0),this.initializeBuffers(),this.ratioWeight=this.fromSampleRate/this.toSampleRate),this.resampler(t)}}const V=132,Z=[255,511,1023,2047,4095,8191,16383,32767];function K(t,e,i){for(let s=0;s<i;s++)if(t<=e[s])return s;return i}function Q(t){const e=[];return Array.prototype.slice.call(t).forEach(((t,i)=>{e[i]=function(t){let e,i,s;return t>=0?e=213:(e=85,(t=-t-1)<0&&(t=32767)),i=K(t,Z,8),i>=8?127^e:(s=i<<4,s|=i<2?t>>4&15:t>>i+3&15,s^e)}(t)})),e}function X(t){const e=[];return Array.prototype.slice.call(t).forEach(((t,i)=>{e[i]=function(t){let e=0;t<0?(t=V-t,e=127):(t+=V,e=255);let i=K(t,Z,8);return i>=8?127^e:(i<<4|t>>i+3&15)^e}(t)})),e}function Y(t){const e=[];return t.forEach((t=>{e[t]=function(t){let e=((15&(t=~t))<<3)+V;return e<<=(112&t)>>4,128&t?V-e:e-V}(t)})),e}class tt{constructor(t){this.log=function(i){if(t._opt.debugLevel==e){const e=t._opt.debugUuid?`[${t._opt.debugUuid}]`:"";for(var s=arguments.length,r=new Array(s>1?s-1:0),o=1;o<s;o++)r[o-1]=arguments[o];console.log(`JbPro${e}[✅✅✅][${i}]`,...r)}},this.warn=function(s){if(t._opt.debugLevel==e||t._opt.debugLevel==i){const e=t._opt.debugUuid?`[${t._opt.debugUuid}]`:"";for(var r=arguments.length,o=new Array(r>1?r-1:0),n=1;n<r;n++)o[n-1]=arguments[n];console.log(`JbPro${e}[❗❗❗][${s}]`,...o)}},this.error=function(e){const i=t._opt.debugUuid?`[${t._opt.debugUuid}]`:"";for(var s=arguments.length,r=new Array(s>1?s-1:0),o=1;o<s;o++)r[o-1]=arguments[o];console.error(`JbPro${i}[❌❌❌][${e}]`,...r)}}}class et{constructor(t){this.destroys=[],this.proxy=this.proxy.bind(this),this.master=t}proxy(t,e,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(!t)return;if(Array.isArray(e))return e.map((e=>this.proxy(t,e,i,s)));t.addEventListener(e,i,s);const r=()=>{"function"==typeof t.removeEventListener&&t.removeEventListener(e,i,s)};return this.destroys.push(r),r}destroy(){this.master.debugLog("Events","destroy"),this.destroys.forEach((t=>t())),this.destroys=[]}}class it{constructor(t){this.TAG_NAME="AudioTalkLoader",this.player=t,this.audioContext=this._createAudioContext(),this.engineType=this._getAutoAudioEngineType(),this.audioBufferSize=this._getAudioBufferSizeByType(),this.audioChannel=this._getAudioChannel(),this.stashBuffer=new Float32Array(0),this.bufferList=[],this.$audio=null,this.gainNode=this.audioContext.createGain(),this.scriptNode=null,this.mediaStreamAudioDestinationNode=null,this.scriptStartTime=0,this.scriptNodeInterval=null,j()&&(this.mediaStreamAudioDestinationNode=this.audioContext.createMediaStreamDestination()),this._initScriptNode(),this.player.debugLog(this.TAG_NAME,"init")}async destroy(){this.scriptNodeInterval&&(clearInterval(this.scriptNodeInterval),this.scriptNodeInterval=null),this.audioContext&&(await this.audioContext.close(),this.audioContext=null),this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.scriptNode&&(this.scriptNode.disconnect(),this.scriptNode.onaudioprocess=I,this.scriptNode=null),this.mediaStreamAudioDestinationNode&&(this.mediaStreamAudioDestinationNode.disconnect(),this.mediaStreamAudioDestinationNode=null),this.player.debugLog(this.TAG_NAME,"destroy")}get oneBufferDuration(){return this.audioBufferSize/this.audioContext.sampleRate*1e3}_createAudioContext(){let t=48e3;return(this.player._opt.isG711a||this.player._opt.isG711u)&&(t=8e3),new(window.AudioContext||window.webkitAudioContext)({sampleRate:t})}_getAudioChannel(){let t=1;return(this.player._opt.isG711a||this.player._opt.isG711u)&&(t=1),t}_getAutoAudioEngineType(){let t=D;return(()=>{t=$()?P:(j()&&this.player._opt.supportLockScreenPlayAudio||"https:"!==window.location.protocol&&"localhost"!==window.location.hostname||this._supportAudioWorklet(),D)})(),t}_getAudioBufferSizeByType(){return this.engineType===x?1024:this.engineType===P?4800:(this.engineType,1024)}_supportAudioWorklet(){return this.audioContext&&this.audioContext.audioWorklet&&"function"==typeof this.audioContext.audioWorklet.addModule}_initScriptNode(){this.engineType===x?this._initWorkletScriptNode():this.engineType===P?this._initIntervalScriptNode():this.engineType===D&&this._initProcessScriptNode()}_initWorkletScriptNode(){this.player.debugLog(this.TAG_NAME,"_initWorkletScriptNode()")}_initIntervalScriptNode(){this.scriptStartTime=0;const t=1e3*this.audioBufferSize/this.audioContext.sampleRate;this.player.debugLog(this.TAG_NAME,`_initIntervalScriptNode() and interval time is ${t}`),this.scriptNodeInterval=setInterval((()=>{if(0===this.bufferList.length||this.isMute())return;const t=this.audioContext.createBufferSource(),e=this.audioContext.createBuffer(this.audioChannel,this.audioBufferSize,this.audioContext.sampleRate);this._handleScriptNodeCallback(e,(()=>{this.scriptStartTime<this.audioContext.currentTime&&(this.player.debugLog("AudioContext",`script start time ${this.scriptStartTime} is less than current time ${this.audioContext.currentTime}`),this.scriptStartTime=this.audioContext.currentTime),t.buffer=e,t.connect(this.gainNode),t.start(this.scriptStartTime),this.scriptStartTime+=e.duration}))}),t),this.gainNode.connect(this.mediaStreamAudioDestinationNode),this.$audio?this.$audio.srcObject=this.mediaStreamAudioDestinationNode.stream:this.gainNode.connect(this.audioContext.destination)}_initProcessScriptNode(){this.player.debugLog(this.TAG_NAME,"_initProcessScriptNode()");const t=this.audioContext.createScriptProcessor(this.audioBufferSize,0,this.audioChannel);t.onaudioprocess=t=>{const e=t.outputBuffer;this._handleScriptNodeCallback(e)},t.connect(this.gainNode),this.scriptNode=t,this.gainNode.connect(this.mediaStreamAudioDestinationNode),this.$audio?this.$audio.srcObject=this.mediaStreamAudioDestinationNode.stream:this.gainNode.connect(this.audioContext.destination)}_handleScriptNodeCallback(t,e){let i,s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];e=e||I,t.length,s&&(i=t,this.audioBufferSize);const r=this.audioChannel;let o=this.bufferList.shift();o&&o.size>0?s?i.port.postMessage({message:"data",buffer:o}):this._fillScriptNodeOutputBuffer(t,r,o):(s?i.port.postMessage({message:"zero"}):this._fillScriptNodeOutputBuffer(t,r),e())}_fillScriptNodeOutputBuffer(t,e,i){if(1===e){const e=t.getChannelData(0);i?0===i.size?e.fill(0):e.set(i.left):e.fill(0)}else if(2===e){const e=t.getChannelData(0),s=t.getChannelData(1);i?0===i.size?(e.fill(0),s.fill(0)):(e.set(i.left),s.set(i.right)):(e.fill(0),s.fill(0))}}isMute(){return 0===this.gainNode.gain.value}_isMoreThanMinBufferDuration(){return this.getBufferListDuration()>=100}getBufferListDuration(){return this.bufferList.length*this.oneBufferDuration}play(t){let e=t;this.player._opt.isG711a?e=function(t){const e=[];return t.forEach((t=>{e[t]=function(t){let e,i;switch(e=(15&(t^=85))<<4,i=(112&t)>>4,i){case 0:e+=8;break;case 1:e+=264;break;default:e+=264,e<<=i-1}return 0!=(128&t)?e:-e}(t)})),e}(t):this.player._opt.isG711u&&(e=Y(t));const i=new Float32Array(e.length+this.stashBuffer.length);for(i.set(this.stashBuffer,0),i.set(e,this.stashBuffer.length),this.stashBuffer=i;this.stashBuffer.length>this.audioBufferSize;){const t=this.stashBuffer.subarray(0,this.audioBufferSize);this.bufferList.push({size:t.length,left:t,right:null}),this.stashBuffer=this.stashBuffer.subarray(this.audioBufferSize)}}}class st extends t{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),this._opt={},t&&(this.player=t),this.TAG_NAME="talk";const i=q(O);this._opt=Object.assign({},i,e),this.player||(this.debug=new tt(this)),this.log(this.TAG_NAME,"init and version is",'"7-30-2024"'),this._opt.sampleRate=parseInt(this._opt.sampleRate,10),this._opt.sampleBitsWidth=parseInt(this._opt.sampleBitsWidth,10),this._opt.encType!==T&&this._opt.encType!==k||8e3===this._opt.sampleRate&&16===this._opt.sampleBitsWidth||(this.warn(this.TAG_NAME,`\n            encType is ${this._opt.encType} and sampleRate is ${this._opt.sampleRate}, and sampleBitsWidth is ${this._opt.sampleBitsWidth}。\n            ${this._opt.encType} only support sampleRate 8000 and sampleBitsWidth 16`),this._opt.sampleRate=8e3,this._opt.sampleBitsWidth=16),this._opt.packetType===L&&this._opt.encType===y&&(this.warn(this.TAG_NAME,`packetType is ${this._opt.packetType} and encType is ${this._opt.encType}, rtp only support g711a or g711u or opus so set packetType to empty`),this._opt.packetType=v),this._opt.packetType,this._opt.encType,this.audioContext=null,this.gainNode=null,this.recorder=null,this.workletRecorder=null,this.biquadFilter=null,this.userMediaStream=null,this.clearWorkletUrlTimeout=null,this.bufferSize=512,this._opt.audioBufferLength=this.calcAudioBufferLength(),this.audioBufferList=[],this.opusEncoder=null,this.opusDecoder=null,this.resampler=null,this._opt.encType,this.socket=null,this.socketStatus=g,this.mediaStreamSource=null,this.heartInterval=null,this.checkGetUserMediaTimeout=null,this.wsUrl=null,this.startTimestamp=0,this.sequenceId=0,this.tempTimestamp=null,this._destroyed=!1,this.tempG711BufferList=new Uint8Array(0),this.tempRtpBufferList=new Uint8Array(0),this.tempJttBufferList=new Uint8Array(0),this.tempPcmBufferList=new Uint8Array(0),this.tempOpusBufferList=new Uint8Array(0),this.events=new et(this),this.audioPlayer=null,this._initTalk();try{this.log(this.TAG_NAME,"init",JSON.stringify(this._opt))}catch(t){this.log(this.TAG_NAME,"init",this._opt)}}destroy(){this._destroyed=!0,this.clearWorkletUrlTimeout&&(clearTimeout(this.clearWorkletUrlTimeout),this.clearWorkletUrlTimeout=null),this.userMediaStream&&(this.userMediaStream.getTracks&&this.userMediaStream.getTracks().forEach((t=>{t.stop()})),this.userMediaStream=null),this.mediaStreamSource&&(this.mediaStreamSource.disconnect(),this.mediaStreamSource=null),this.recorder&&(this.recorder.disconnect(),this.recorder.onaudioprocess=null,this.recorder=null),this.biquadFilter&&(this.biquadFilter.disconnect(),this.biquadFilter=null),this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.workletRecorder&&(this.workletRecorder.disconnect(),this.workletRecorder=null),this.opusEncoder&&(this.opusEncoder.destroy(),this.opusEncoder=null),this.opusDecoder&&(this.opusDecoder.destroy(),this.opusDecoder=null),this.resampler&&(this.resampler.destroy(),this.resampler=null),this.socket&&(this.socketStatus===w&&this._sendClose(),this.socket.close(),this.socket=null),this.audioPlayer&&(this.audioPlayer.destroy(),this.audioPlayer=null),this._stopHeartInterval(),this._stopCheckGetUserMediaTimeout(),this.audioContext=null,this.gainNode=null,this.recorder=null,this.audioBufferList=[],this.sequenceId=0,this.wsUrl=null,this.tempTimestamp=null,this.tempRtpBufferList=null,this.tempG711BufferList=null,this.tempPcmBufferList=null,this.tempOpusBufferList=null,this.startTimestamp=0,this.log(this.TAG_NAME,"destroy")}isDestroyed(){return this._destroyed}addRtpToBuffer(t){const e=t.length+this.tempRtpBufferList.length,i=new Uint8Array(e);i.set(this.tempRtpBufferList,0),i.set(t,this.tempRtpBufferList.length),this.tempRtpBufferList=i}addG711ToBuffer(t){const e=t.length+this.tempG711BufferList.length,i=new Uint8Array(e);i.set(this.tempG711BufferList,0),i.set(t,this.tempG711BufferList.length),this.tempG711BufferList=i}addPcmToBuffer(t){const e=t.length+this.tempPcmBufferList.length,i=new Uint8Array(e);i.set(this.tempPcmBufferList,0),i.set(t,this.tempPcmBufferList.length),this.tempPcmBufferList=i}addJttToBuffer(t){const e=t.length+this.tempJttBufferList.length,i=new Uint8Array(e);i.set(this.tempJttBufferList,0),i.set(t,this.tempJttBufferList.length),this.tempJttBufferList=i}addOpusToBuffer_1(t){this.opusDecoder||(this.opusDecoder=new OpusDecoder(this._opt.sampleRate,this._opt.numberChannels));const e=this.opusDecoder.decode(t),i=new Uint8Array(e.buffer);this.addPcmToBuffer(i)}addOpusToBuffer(t){const e=this.tempOpusBufferList.length+1+t.length,i=new Uint8Array(e);i.set(this.tempOpusBufferList,0),i.set([t.length],this.tempOpusBufferList.length),i.set(t,this.tempOpusBufferList.length+1),this.tempOpusBufferList=i}downloadRtpFile(){this.debugLog(this.TAG_NAME,"downloadRtpFile");const t=new Blob([this.tempRtpBufferList]);try{const e=document.createElement("a");e.href=window.URL.createObjectURL(t),e.download=Date.now()+".rtp",e.click(),this.tempRtpBufferList=new Uint8Array(0),window.URL.revokeObjectURL(e.href)}catch(t){console.error("downloadRtpFile",t)}}downloadG711File(){this.debugLog(this.TAG_NAME,"downloadG711File");const t=new Blob([this.tempG711BufferList]);try{const e=document.createElement("a");e.href=window.URL.createObjectURL(t),e.download=Date.now()+"."+this._opt.encType,e.click(),this.tempG711BufferList=new Uint8Array(0),window.URL.revokeObjectURL(e.href)}catch(t){console.error("downloadG711File",t)}}downloadOpusFile_1(){this.debugLog(this.TAG_NAME,"downloadOpusFile"),this.downloadPcmFile()}downloadOpusFile(){this.debugLog(this.TAG_NAME,"downloadOpusFile");const t=function(t,e,i){const s=new Uint8Array([79,103,103,83,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),r=new Uint8Array([79,112,117,115,72,101,97,100,1,0,0,0,0,0,0,0,0,0,0,0,255&e,e>>8&255,e>>16&255,e>>24&255,255&i,i>>8&255,0,0,0,0]),o=new Uint8Array(s.length+r.length+t.length);return o.set(s),o.set(r,s.length),o.set(t,s.length+r.length),o}(this.tempOpusBufferList,this._opt.sampleRate,this._opt.numberChannels),e=new Blob([t],{type:"audio/ogg"});try{const t=document.createElement("a");t.href=window.URL.createObjectURL(e),t.download=Date.now()+".ogg",t.click(),this.tempOpusBufferList=new Uint8Array(0),window.URL.revokeObjectURL(t.href)}catch(t){console.error("downloadOpusFile",t)}}downloadPcmFile(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.debugLog(this.TAG_NAME,"downloadPcmFile",this._opt.sampleRate,this._opt.numberChannels,this._opt.sampleBitsWidth);let e=new DataView(this.tempPcmBufferList.buffer),i=null,s="";t?(e=function(t,e,i,s){var r=function(t,e,i){for(var s=0;s<i.length;s++)t.setUint8(e+s,i.charCodeAt(s))},o=e,n=s,a=new ArrayBuffer(44+t.byteLength),h=new DataView(a),l=i,u=0;r(h,u,"RIFF"),u+=4,h.setUint32(u,36+t.byteLength,!0),r(h,u+=4,"WAVE"),r(h,u+=4,"fmt "),u+=4,h.setUint32(u,16,!0),u+=4,h.setUint16(u,1,!0),u+=2,h.setUint16(u,l,!0),u+=2,h.setUint32(u,o,!0),u+=4,h.setUint32(u,l*o*(n/8),!0),u+=4,h.setUint16(u,l*(n/8),!0),u+=2,h.setUint16(u,n,!0),r(h,u+=2,"data"),u+=4,h.setUint32(u,t.byteLength,!0),u+=4;for(let e=0;e<t.byteLength;)h.setUint8(u,t.getUint8(e)),u++,e++;return h}(e,this._opt.sampleRate,this._opt.numberChannels,this._opt.sampleBitsWidth),s=".wav",i=new Blob([e],{type:"audio/wav"})):(s=".pcm",i=new Blob([this.tempPcmBufferList]));try{const t=document.createElement("a");t.href=window.URL.createObjectURL(i),t.download=Date.now()+s,t.click(),this.tempPcmBufferList=new Uint8Array(0),window.URL.revokeObjectURL(t.href)}catch(t){console.error("downloadRtpFile",t)}}downloadJttFile(){this.debugLog(this.TAG_NAME,"downloadJttFile");const t=new Blob([this.tempJttBufferList]);try{const e=document.createElement("a");e.href=window.URL.createObjectURL(t),e.download=Date.now()+".jtt",e.click(),this.tempJttBufferList=new Uint8Array(0),window.URL.revokeObjectURL(e.href)}catch(t){console.error("downloadJttFile",t)}}downloadFile(){this._opt.packetType===L?this.downloadRtpFile():this._opt.packetType===M?this.downloadJttFile():this._opt.encType===T||this._opt.encType===k?this.downloadG711File():this._opt.encType===A?this.downloadOpusFile():this._opt.encType===y&&this.downloadPcmFile()}calcAudioBufferLength(){const{sampleRate:t,sampleBitsWidth:e,frameDuration:i}=this._opt;return t*e*(i/1e3)/8}get socketStatusOpen(){return this.socketStatus===w}log(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this._log("log",...e)}warn(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this._log("warn",...e)}error(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this._log("error",...e)}_log(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];this.player?this.player.debug[t](...i):this.debug?this.debug[t](...i):console[t](...i)}_getSequenceId(){return++this.sequenceId}_createWebSocket(t){return new Promise(((e,i)=>{const s=this.events.proxy;this.socket=new WebSocket(this.wsUrl,t.protocols||[]),this.socket.binaryType="arraybuffer",this.emit(a),s(this.socket,G,(()=>{this.socketStatus=w,this.log(this.TAG_NAME,"websocket open -> do talk"),this.emit(h),e(),this._doTalk()})),s(this.socket,R,(t=>{"string"!=typeof t.data?this._handleMessage(t.data):this.debugWarn(this.TAG_NAME,`websocket handle message message is "${t.data}" string so return`)})),s(this.socket,C,(t=>{this.socketStatus=_,this.warn(this.TAG_NAME,"websocket close -> reject",t),this.emitError(l),i(t)})),s(this.socket,N,(t=>{this.socketStatus=b,this.error(this.TAG_NAME,"websocket error -> reject",t),this.emitError(u,t),i(t)}))}))}_sendClose(){}_initTalk(){this._initMethods(),this._opt.engine===W?this._initWorklet():this._opt.engine===F&&this._initScriptProcessor(),this.log(this.TAG_NAME,"audioContext samplerate",this.audioContext.sampleRate)}_initMethods(){this.audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:48e3}),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=1,this.biquadFilter=this.audioContext.createBiquadFilter(),this.biquadFilter.type="lowpass",this.biquadFilter.frequency.value=3e3,this.resampler=new H({fromSampleRate:this.audioContext.sampleRate,toSampleRate:this._opt.sampleRate,channels:this._opt.numberChannels,inputBufferSize:this.bufferSize})}_initScriptProcessor(){const t=this.audioContext.createScriptProcessor||this.audioContext.createJavaScriptNode;this.recorder=t.apply(this.audioContext,[this.bufferSize,this._opt.numberChannels,this._opt.numberChannels]),this.recorder.onaudioprocess=t=>this._onaudioprocess(t)}_initWorklet(){const t=function(t){const e=t.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],i=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(i)}((function(){class t extends AudioWorkletProcessor{constructor(t){super(),this._cursor=0,this._bufferSize=t.processorOptions.bufferSize,this._buffer=new Float32Array(this._bufferSize)}process(t,e,i){if(!t.length||!t[0].length)return!0;for(let e=0;e<t[0][0].length;e++)this._cursor+=1,this._cursor===this._bufferSize&&(this._cursor=0,this.port.postMessage({eventType:"data",buffer:this._buffer})),this._buffer[this._cursor]=t[0][0][e];return!0}}registerProcessor("talk-processor",t)}));this.audioContext.audioWorklet&&this.audioContext.audioWorklet.addModule(t).then((()=>{const t=new AudioWorkletNode(this.audioContext,"talk-processor",{processorOptions:{bufferSize:this.bufferSize}});t.connect(this.gainNode),t.port.onmessage=t=>{"data"===t.data.eventType&&this._encodeAudioData(t.data.buffer)},this.workletRecorder=t})),this.clearWorkletUrlTimeout=setTimeout((()=>{URL.revokeObjectURL(t),this.clearWorkletUrlTimeout=null}),1e4)}_onaudioprocess(t){const e=t.inputBuffer.getChannelData(0);this._encodeAudioData(new Float32Array(e))}_encodeAudioData(t){if(this.isDestroyed())return;if(0===t[0]&&0===t[1])return void this.log(this.TAG_NAME,"empty audio data");const e=this.resampler.resample(t);if(this._opt.encType===A);else{let t=e;16===this._opt.sampleBitsWidth?t=function(t){let e=t.length,i=new Int16Array(e);for(;e--;){let s=Math.max(-1,Math.min(1,t[e]));i[e]=s<0?32768*s:32767*s}return i}(e):8===this._opt.sampleBitsWidth?t=function(t){let e=t.length,i=new Int8Array(e);for(;e--;){let s=Math.max(-1,Math.min(1,t[e]));const r=s<0?32768*s:32767*s;i[e]=parseInt(255/(65535/(32768+r)),10)}return i}(e):32===this._opt.sampleBitsWidth&&(t=function(t){let e=t.length,i=new Int32Array(e);for(;e--;){let s=Math.max(-1,Math.min(1,t[e]));i[e]=s<0?2147483648*s:2147483647*s}return i}(e));let i=null;this._opt.encType===T?i=Q(t):this._opt.encType===k?i=X(t):this._opt.encType===y&&(i=t.buffer);const s=new Uint8Array(i);for(let t=0;t<s.length;t++){let e=this.audioBufferList.length;this.audioBufferList[e++]=s[t],this.audioBufferList.length===this._opt.audioBufferLength&&(this._sendTalkMsg(new Uint8Array(this.audioBufferList)),this.audioBufferList=[])}}}_parseAudioMsg(t){let e=null;return this._opt.packetType!==L||this._opt.encType!==T&&this._opt.encType!==k&&this._opt.enc!==A?this._opt.packetType!==M||this._opt.encType!==T&&this._opt.encType!==k?this._opt.packetType===v&&(e=t):e=this.jttPacket(t):e=this.rtpPacket(t),e}rtpPacket(t){const e=[];let i=0,s=0,r=0;const o=this._opt.rtpSsrc,n=t.length;this._opt.encType===T?i=S:this._opt.encType===k?i=E:this._opt.encType===A&&(i=B),this.startTimestamp||(this.startTimestamp=z()),r=z()-this.startTimestamp,s=this._getSequenceId();let a=0;if(this._opt.packetTcpSendType===U){const t=n+12;e[a++]=255&t>>8,e[a++]=255&t>>0}e[a++]=128,e[a++]=128+i,e[a++]=s/256,e[a++]=s%256,e[a++]=r/65536/256,e[a++]=r/65536%256,e[a++]=r%65536/256,e[a++]=r%65536%256,e[a++]=o/65536/256,e[a++]=o/65536%256,e[a++]=o%65536/256,e[a++]=o%65536%256;let h=e.concat([...t]),l=new Uint8Array(h.length);for(let t=0;t<h.length;t++)l[t]=h[t];return l}jttPacket(t){const e=[],i=[48,49,99,100],s=[129,134];let r=0;const o=this._opt.jttSimNumber,n=this._opt.jttChannelNumber;let a=0;const h=t.length;this.startTimestamp||(this.startTimestamp=z()),a=z()-this.startTimestamp,r=this._getSequenceId(),e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=s[0],e[5]=s[1],e[6]=r/256,e[7]=r%256;const l=function(t){if((t=t.replace(/\s/g,"")).length%2!=0)return console.error("hexStringToUint8Array: invalid hexString length, must be even and bexString length is: ",t.length),null;const e=new Uint8Array(t.length/2);for(let i=0;i<t.length;i+=2){const s=parseInt(t.substr(i,2),16);e[i/2]=s}return e}(o);l&&(e[8]=l[0],e[9]=l[1],e[10]=l[2],e[11]=l[3],e[12]=l[4],e[13]=l[5]),e[14]=parseInt(n,16),e[15]=48,e[16]=255&a>>56,e[17]=255&a>>48,e[18]=255&a>>40,e[19]=255&a>>32,e[20]=255&a>>24,e[21]=255&a>>16,e[22]=255&a>>8,e[23]=255&a>>0,e[24]=h/256,e[25]=h%256;let u=e.concat([...t]),d=new Uint8Array(u.length);for(let t=0;t<u.length;t++)d[t]=u[t];return d}_sendTalkMsg(t){null===this.tempTimestamp&&(this.tempTimestamp=z());const e=z(),i=e-this.tempTimestamp,s=this._parseAudioMsg(t);this.log(this.TAG_NAME,`send talk msg and diff is ${i} and byteLength is ${s.byteLength} and length is ${s.length}, and ${this._opt.encType} length is ${t.length}`),J(this._opt.saveToTempFile)&&J(this._opt.debug)&&(this._opt.packetType===L?this.addRtpToBuffer(s):this._opt.packetType===M?this.addJttToBuffer(s):this._opt.encType===T||this._opt.encType===k?this.addG711ToBuffer(s):this._opt.encType===y?this.addPcmToBuffer(s):this._opt.encType===A&&this.addOpusToBuffer(s)),s&&(this._opt.testMicrophone?this.emit(c,s.buffer):this.socketStatusOpen?this.socket.send(s.buffer):this.emitError(m.tallWebsocketClosedByError)),this.tempTimestamp=e}_doTalk(){this._getUserMedia(),this._opt.openWebsocketHeart&&this._startHeartInterval()}_getUserMedia(){this.log(this.TAG_NAME,"getUserMedia"),void 0===window.navigator.mediaDevices&&(window.navigator.mediaDevices={}),void 0===window.navigator.mediaDevices.getUserMedia&&(this.log(this.TAG_NAME,"window.navigator.mediaDevices.getUserMedia is undefined and init function"),window.navigator.mediaDevices.getUserMedia=function(t){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return e?new Promise((function(i,s){e.call(navigator,t,i,s)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}),this._opt.checkGetUserMediaTimeout&&this._startCheckGetUserMediaTimeout(),window.navigator.mediaDevices.getUserMedia({audio:this._opt.audioConstraints,video:!1}).then((t=>{this.log(this.TAG_NAME,"getUserMedia success"),this.userMediaStream=t,this.mediaStreamSource=this.audioContext.createMediaStreamSource(t),this.mediaStreamSource.connect(this.biquadFilter),this.recorder?(this.biquadFilter.connect(this.recorder),this.recorder.connect(this.gainNode)):this.workletRecorder&&(this.biquadFilter.connect(this.workletRecorder),this.workletRecorder.connect(this.gainNode)),this.gainNode.connect(this.audioContext.destination),this.emit(r),null===t.oninactive&&(t.oninactive=t=>{this._handleStreamInactive(t)})})).catch((t=>{this.error(this.TAG_NAME,"getUserMedia error",t.toString()),this.emit(o,t.toString())})).finally((()=>{this.log(this.TAG_NAME,"getUserMedia finally"),this._stopCheckGetUserMediaTimeout()}))}_getUserMedia2(){this.log(this.TAG_NAME,"getUserMedia"),navigator.mediaDevices?navigator.mediaDevices.getUserMedia({audio:!0}).then((t=>{this.log(this.TAG_NAME,"getUserMedia2 success")})):navigator.getUserMedia({audio:!0},this.log(this.TAG_NAME,"getUserMedia2 success"),this.log(this.TAG_NAME,"getUserMedia2 fail"))}async _getUserMedia3(){this.log(this.TAG_NAME,"getUserMedia3");try{const t=await navigator.mediaDevices.getUserMedia({audio:{latency:!0,noiseSuppression:!0,autoGainControl:!0,echoCancellation:!0,sampleRate:48e3,channelCount:1},video:!1});console.log("getUserMedia() got stream:",t),this.log(this.TAG_NAME,"getUserMedia3 success")}catch(t){this.log(this.TAG_NAME,"getUserMedia3 fail")}}_handleStreamInactive(t){this.userMediaStream&&(this.warn(this.TAG_NAME,"stream oninactive",t),this.emit(d))}_startCheckGetUserMediaTimeout(){this._stopCheckGetUserMediaTimeout(),this.checkGetUserMediaTimeout=setTimeout((()=>{this.log(this.TAG_NAME,"check getUserMedia timeout"),this.emit(n)}),this._opt.getUserMediaTimeout)}_stopCheckGetUserMediaTimeout(){this.checkGetUserMediaTimeout&&(this.log(this.TAG_NAME,"stop checkGetUserMediaTimeout"),clearTimeout(this.checkGetUserMediaTimeout),this.checkGetUserMediaTimeout=null)}_startHeartInterval(){this.heartInterval=setInterval((()=>{this.log(this.TAG_NAME,"heart interval");let t=this._opt.websocketHeartContent;t=new Uint8Array(t),this.socket.send(t.buffer)}),1e3*this._opt.websocketHeartInterval)}_stopHeartInterval(){this.heartInterval&&(this.log(this.TAG_NAME,"stop heart interval"),clearInterval(this.heartInterval),this.heartInterval=null)}startTalk(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise(((i,s)=>{if(!function(){let t=!1;const e=window.navigator;return e&&(t=!(!e.mediaDevices||!e.mediaDevices.getUserMedia),t||(t=!!(e.getUserMedia||e.webkitGetUserMedia||e.mozGetUserMedia||e.msGetUserMedia))),t}())return s("not support getUserMedia");if(this._opt.packetType===M){if(!this._opt.jttSimNumber||12!==(""+this._opt.jttSimNumber).length)return s("jttSimNumber is null or length is not 12");if(!this._opt.jttChannelNumber||2!==(""+this._opt.jttChannelNumber).length)return s("jttChannelNumber is null or length is not 2")}if(this.wsUrl=t,this._opt.testMicrophone)this._doTalk();else{if(!this.wsUrl)return s("wsUrl is null");this._createWebSocket(e).catch((t=>{s(t)}))}this.once(o,(()=>{s("getUserMedia fail")})),this.once(r,(()=>{i()}))}))}setVolume(t){var e,i,s;(t=parseFloat(t).toFixed(2),isNaN(t))||(e=t,i=0,s=1,t=Math.max(Math.min(e,Math.max(i,s)),Math.min(i,s)),this.gainNode.gain.value=t)}getOption(){return this._opt}get volume(){return this.gainNode?parseFloat(100*this.gainNode.gain.value).toFixed(0):null}debugLog(t){if(this._opt.debug&&this.debug){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];this.debug.log(t,...i)}}debugWarn(t){if(this._opt.debug&&this.debug){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];this.debug.warn(t,...i)}}debugError(t){if(this.debug){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];this.debug.error(t,...i)}}_handleMessage(t){null===this.audioPlayer&&(this.audioPlayer=new it(this)),this.audioPlayer.play(t)}emitError(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";this.emit(s,t,e),this.emit(t,e)}}class rt extends t{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(),this.talk=null,this._opt=t,this.LOG_TAG="JbProTalk",this.debug=new tt(this);try{this.debugLog(this.LOG_TAG,"init",JSON.stringify(t))}catch(e){this.debugLog(this.LOG_TAG,"init",t)}}destroy(){this.debugLog(this.LOG_TAG,"destroy()"),this.off(),this.talk&&(this.talk.destroy(),this.talk=null),this.debugLog(this.LOG_TAG,"destroy")}_initTalk(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.talk&&(this.debugLog(this.LOG_TAG,"_initTalk this.talk is not null and destroy"),this.talk.destroy(),this.talk=null);const e=Object.assign({},q(this._opt),t);this._opt=e,this.talk=new st(null,e),this.debugLog(this.LOG_TAG,"_initTalk",this.talk.getOption()),this._bindTalkEvents()}_bindTalkEvents(){Object.keys(f).forEach((t=>{this.talk.on(f[t],(e=>{this.emit(t,e)}))}))}startTalk(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new Promise(((s,r)=>{try{this.debugLog(this.LOG_TAG,"startTalk",t,JSON.stringify(e))}catch(i){this.debugLog(this.LOG_TAG,"startTalk",t,e)}this._initTalk(e),this.talk.startTalk(t,i).then((()=>{s(),this.talk.once(l,this._handleTalkStreamClose.bind(this)),this.talk.once(u,this._handleTalkStreamError.bind(this)),this.talk.once(d,this._handleTalkStreamInactive.bind(this)),this.talk.once(n,this._handleTalkGetUserMediaTimeout.bind(this)),this.talk.once(m.tallWebsocketClosedByError,this._handleTalkWebsocketClosedByError.bind(this))})).catch((t=>{r(t)}))}))}stopTalk(){return new Promise(((t,e)=>{this.debugLog(this.LOG_TAG,"stopTalk()"),this.talk||e("talk is not init"),this.talk.destroy(),this.talk=null,t()}))}getTalkVolume(){return new Promise(((t,e)=>{this.talk||e("talk is not init"),t(this.talk.volume)}))}setTalkVolume(t){return new Promise(((e,i)=>{this.debugLog(this.LOG_TAG,"setTalkVolume",t),this.talk||i("talk is not init"),this.talk.setVolume(t/100),e()}))}downloadTempRtpFile(){return new Promise(((t,e)=>{this.talk?(this.talk.downloadRtpFile(),t()):e("talk is not init")}))}downloadTempG711File(){return new Promise(((t,e)=>{this.talk?(this.talk.downloadG711File(),t()):e("talk is not init")}))}downloadTempPcmFile(t){return new Promise(((e,i)=>{this.talk?(this.talk.downloadPcmFile(t),e()):i("talk is not init")}))}downloadTempOpusFile(){return new Promise(((t,e)=>{this.talk?(this.talk.downloadOpusFile(),t()):e("talk is not init")}))}downloadTempFile(){return new Promise(((t,e)=>{this.talk?(this.talk.downloadFile(),t()):e("talk is not init")}))}debugLog(t){if(this._opt.debug&&this.debug){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];this.debug.log(t,...i)}}debugWarn(t){if(this._opt.debug&&this.debug){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];this.debug.warn(t,...i)}}debugError(t){if(this.debug){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];this.debug.error(t,...i)}}_handleTalkStreamClose(){this.debugWarn(this.LOG_TAG,"talkStreamClose -> stopTalk"),this.stopTalk().catch((t=>{this.debugWarn(this.LOG_TAG,"talkStreamClose stopTalk",t)})).finally((()=>{this.emit(p,l)}))}_handleTalkStreamError(){this.debugError(this.LOG_TAG,"talkStreamError -> stopTalk"),this.stopTalk().catch((t=>{this.debugWarn(this.LOG_TAG,"talkStreamError stopTalk",t)})).finally((()=>{this.emit(p,u)}))}_handleTalkStreamInactive(){this.debugWarn(this.LOG_TAG,"talkStreamInactive -> stopTalk"),this.stopTalk().catch((t=>{this.debugWarn(this.LOG_TAG,"talkStreamInactive stopTalk",t)})).finally((()=>{this.emit(p,d)}))}_handleTalkGetUserMediaTimeout(){this.debugWarn(this.LOG_TAG,"talkGetUserMediaTimeout -> stopTalk"),this.stopTalk().catch((t=>{this.debugWarn(this.LOG_TAG,"talkGetUserMediaTimeout stopTalk",t)})).finally((()=>{this.emit(p,n)}))}_handleTalkWebsocketClosedByError(){this.debugWarn(this.LOG_TAG,"talkWebsocketClosedByError -> stopTalk"),this.stopTalk().catch((t=>{this.debugWarn(this.LOG_TAG,"talkWebsocketClosedByError stopTalk",t)})).finally((()=>{this.emit(p,m.tallWebsocketClosedByError)}))}}return rt.EVENTS=f,window.JessibucaProTalk=rt,window.JbProTalk=rt,window.WebPlayerProTalk=rt,rt}));
